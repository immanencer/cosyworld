<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Chat Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #gameContainer { display: flex; height: 100vh; }
        #mapContainer { flex: 2; }
        #chatContainer { flex: 1; overflow-y: auto; padding: 10px; background: #f0f0f0; }
        .message { margin-bottom: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
        .system-message { text-align: center; font-style: italic; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="mapContainer"></div>
        <div id="chatContainer"></div>
    </div>

    <script>
    // Game engine
    class GameEngine {
        constructor() {
            this.scene = new THREE.Scene();
            this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            this.renderer = new THREE.WebGLRenderer();
            this.renderer.setSize(window.innerWidth * 0.66, window.innerHeight);
            document.getElementById('mapContainer').appendChild(this.renderer.domElement);

            this.avatars = [];
            this.messages = [];

            this.initScene();
            this.loadData();
            this.animate();
        }

        initScene() {
            this.camera.position.z = 5;
            const light = new THREE.PointLight(0xffffff, 1, 100);
            light.position.set(0, 0, 10);
            this.scene.add(light);
        }

        async loadData() {
            // Simulated data fetch
            const data = await this.fetchData();
            this.createAvatars(data.avatars);
            this.updateChat(data.messages);
        }

        async fetchData() {
            // Simulated MongoDB fetch
            return {
                avatars: [
                    { id: 1, url: 'https://i.imgur.com/example1.png', position: { x: Math.random() * 10 - 5, y: Math.random() * 10 - 5, z: Math.random() * 10 - 5 } },
                    { id: 2, url: 'https://i.imgur.com/example2.png', position: { x: Math.random() * 10 - 5, y: Math.random() * 10 - 5, z: Math.random() * 10 - 5 } }
                ],
                messages: [
                    { id: 1, avatarId: 1, content: 'Hello world!' },
                    { id: 2, avatarId: null, content: 'System message', isSystem: true },
                    { id: 3, avatarId: 2, content: 'Hi there!' }
                ]
            };
        }

        createAvatars(avatarData) {
            avatarData.forEach(avatar => {
                const geometry = new THREE.SphereGeometry(0.5, 32, 32);
                const texture = new THREE.TextureLoader().load(avatar.url);
                const material = new THREE.MeshBasicMaterial({ map: texture });
                const sphere = new THREE.Mesh(geometry, material);
                sphere.position.set(avatar.position.x, avatar.position.y, avatar.position.z);
                this.scene.add(sphere);
                this.avatars.push({ id: avatar.id, object: sphere });
            });
        }

        updateChat(messages) {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = message.isSystem ? 'message system-message' : 'message';
                if (!message.isSystem) {
                    const avatar = this.avatars.find(a => a.id === message.avatarId);
                    if (avatar) {
                        const avatarImg = document.createElement('img');
                        avatarImg.src = avatar.object.material.map.source.data.currentSrc;
                        avatarImg.className = 'avatar';
                        messageElement.appendChild(avatarImg);
                    }
                }
                messageElement.appendChild(document.createTextNode(message.content));
                chatContainer.appendChild(messageElement);
            });
        }

        animate() {
            requestAnimationFrame(() => this.animate());
            this.renderer.render(this.scene, this.camera);
        }
    }

    // Initialize game
    const game = new GameEngine();

    // Handle window resize
    window.addEventListener('resize', () => {
        game.camera.aspect = window.innerWidth / window.innerHeight;
        game.camera.updateProjectionMatrix();
        game.renderer.setSize(window.innerWidth * 0.66, window.innerHeight);
    });
    </script>
</body>
</html>